{% comment %}
  Product Card
{% endcomment %}

{% assign image_width = image_width %}
{% assign image_alt = product.featured_image.alt | escape | strip_html | strip_newlines | default: product.title %}

<div class="product-card">
  <a class="product-card__image-link" href="{{ product.url }}">
    <div
      class="product-card__image-wrapper"
      {% if product.images.size > 1 %}
        x-data="
          {
            isHovering: false,
            splideInstance: null,
            isSplideLoaded: false,
            showSlider: false,
            initSlider() {
              if (!this.isHovering || !this.isSplideLoaded || this.splideInstance) return;

              const sliderHTML = `
                <div class='product-card__slider-wrapper'>
                  <div class='splide product-card__slider'>
                    <div class='splide__track'>
                      <ul class='splide__list'>
                        {% for image in product.images %}
                          <li class='splide__slide'>
                            <img
                              src='{{ image | image_url: width: image_width}}'
                              alt='{{ image.alt | escape | default: product.title }}'
                              class='product-card__image'
                              width='{{ image_width }}'
                              loading='lazy'
                            >
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
              `;

              this.$refs.sliderContainer.innerHTML = sliderHTML;

              try {
                this.splideInstance = new Splide(this.$refs.sliderContainer.querySelector('.splide'), {
                  type: 'fade',
                  arrows: true,
                  pagination: false,
                  speed: 400
                });

                this.splideInstance.mount();
                this.showSlider = true;
              } catch (e) {
                console.error('Failed to initialize Splide', e);
                this.isSplideLoaded = false;
              }
            }
          }
        "
        x-init="
          const checkSplide = () => {
            if (typeof window.Splide !== 'undefined') {
              isSplideLoaded = true;
              if (isHovering) initSlider();
            } else {
              setTimeout(checkSplide, 100);
            }
          };
          checkSplide();
        "
        @mouseenter="
          isHovering = true;
          if (isSplideLoaded) {
            initSlider();
          }
        "
        @mouseleave="
          isHovering = false;
          showSlider = false;
          if (splideInstance) {
            splideInstance.destroy();
            splideInstance = null;
            $refs.sliderContainer.innerHTML = '';
          }
        "
      {% endif %}
    >
      <div>
        {{
          product.featured_image
          | image_url: width: image_width
          | image_tag:
            fetchpriority: high,
            class: 'product-card__image',
            width: image_width,
            alt: image_alt,
            loading: 'eager'
        }}
      </div>

      {% if product.images.size > 1 %}
        <div
          x-ref="sliderContainer"
          x-show="showSlider"
          x-cloak
        ></div>
      {% endif %}
    </div>
  </a>

  <div class="product-card__content">
    <a href="{{ product.url }}" class="product-card__title-link">
      <h2 class="product-card__title body--bold">{{ product.title }}</h2>
    </a>

    {% if product.metafields.custom.fabric_description != blank %}
      <p class="product-card__material small">
        {{ product.metafields.custom.fabric_description }}
      </p>
    {% endif %}

    <p class="product-card__price small">
      <span class="product-card__price--current">{{ product.price | money }}</span>
      {% if product.compare_at_price > product.price %}
        <span class="product-card__price--compare">{{ product.compare_at_price | money }}</span>
      {% endif %}
    </p>
  </div>
</div>
