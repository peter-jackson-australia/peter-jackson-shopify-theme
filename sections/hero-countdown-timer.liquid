<style>
  .countdown-timer {
    position: relative;
    height: calc(100dvh - var(--space-xl));
    overflow: hidden;
    text-align: center;
    color: var(--white);
  }

  .countdown-timer__background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 1;
  }

  .countdown-timer__overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 2;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
  }

  .countdown-timer__container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 3;
    padding: 0 var(--space-m) var(--space-2xl) var(--space-m);
    display: grid;
    gap: var(--space-s);
  }

  .countdown-timer__blocks {
    display: flex;
    justify-content: center;
    gap: var(--space-m);
  }

  .countdown-timer__block {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 80px;
  }

  .countdown-timer__value {
    display: inline-block;
    width: 100%;
    padding: var(--space-s);
    background-color: transparent;
    border: 1px solid var(--white);
    color: var(--white);
    margin-bottom: var(--space-xs);
  }

  .countdown-timer__label {
    color: var(--white);
  }

  .countdown-timer__message {
    margin-top: var(--space-l);
  }

  .countdown-timer__button-container {
    margin-top: var(--space-m);
  }

  .countdown-timer__final-message,
  .countdown-timer__complete-message {
    display: none;
  }

  @media screen and (max-width: 768px) {
    .countdown-timer__container {
      padding-bottom: var(--space-xl);
      text-align: left;
      justify-items: start;
    }

    .countdown-timer__blocks {
      gap: var(--space-s);
      justify-content: flex-start;
    }

    .countdown-timer__block {
      min-width: 60px;
    }

    .countdown-timer__button-container {
      margin-top: var(--space-s);
    }
  }
</style>

<div id="countdown-timer-{{ section.id }}" class="countdown-timer">
  {% if section.settings.background_image %}
    {{
      section.settings.background_image
      | image_url: width: 2000
      | image_tag: class: 'countdown-timer__background', alt: section.settings.background_image.alt
      | default: section.settings.heading, loading: 'lazy'
    }}
    <div class="countdown-timer__overlay"></div>
  {% endif %}

  <div class="countdown-timer__container">
    {% if section.settings.heading != blank %}
      <h1 class="countdown-timer__heading heading--3xl">
        {{ section.settings.heading }}
      </h1>
    {% endif %}

    {% if section.settings.subheading != blank %}
      <div class="countdown-timer__subheading heading--l">
        {{ section.settings.subheading }}
      </div>
    {% endif %}

    <div id="countdown-timer-blocks-{{ section.id }}" class="countdown-timer__blocks">
      <div class="countdown-timer__block">
        <div id="countdown-timer-days-{{ section.id }}" class="countdown-timer__value heading--xl">00</div>
        <div class="countdown-timer__label body--uppercase">
          {{ section.settings.days_label | default: 'Days' }}
        </div>
      </div>

      <div class="countdown-timer__block">
        <div id="countdown-timer-hours-{{ section.id }}" class="countdown-timer__value heading--xl">00</div>
        <div class="countdown-timer__label body--uppercase">
          {{ section.settings.hours_label | default: 'Hours' }}
        </div>
      </div>

      <div class="countdown-timer__block">
        <div id="countdown-timer-minutes-{{ section.id }}" class="countdown-timer__value heading--xl">00</div>
        <div class="countdown-timer__label body--uppercase">
          {{ section.settings.minutes_label | default: 'Minutes' }}
        </div>
      </div>

      <div class="countdown-timer__block">
        <div id="countdown-timer-seconds-{{ section.id }}" class="countdown-timer__value heading--xl">00</div>
        <div class="countdown-timer__label body--uppercase">
          {{ section.settings.seconds_label | default: 'Seconds' }}
        </div>
      </div>
    </div>

    <div
      id="countdown-timer-final-{{ section.id }}"
      class="countdown-timer__final-message countdown-timer__message heading--xl"
    >
      {{ section.settings.final_message | default: 'Final hours! Do not miss out!' }}
    </div>

    <div
      id="countdown-timer-complete-{{ section.id }}"
      class="countdown-timer__complete-message countdown-timer__message heading--xl"
    >
      {{ section.settings.complete_message | default: 'The countdown has ended!' }}
    </div>

    {% if section.settings.button_label != blank and section.settings.button_link != blank %}
      <div class="countdown-timer__button-container">
        <a
          href="{{ section.settings.button_link }}"
          class="button button--white"
        >
          {{ section.settings.button_label }}
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
  (function() {
    const sectionId = "{{ section.id }}";
    const targetDateStr = "{{ section.settings.target_date }}";
    const finalHoursThreshold = {{ section.settings.final_hours_threshold | default: 3 }};

    const daysElement = document.getElementById("countdown-timer-days-" + sectionId);
    const hoursElement = document.getElementById("countdown-timer-hours-" + sectionId);
    const minutesElement = document.getElementById("countdown-timer-minutes-" + sectionId);
    const secondsElement = document.getElementById("countdown-timer-seconds-" + sectionId);
    const blocksElement = document.getElementById("countdown-timer-blocks-" + sectionId);
    const finalMessageElement = document.getElementById("countdown-timer-final-" + sectionId);
    const completeMessageElement = document.getElementById("countdown-timer-complete-" + sectionId);

    function getMelbourneTime() {
      const [datePart, timePart] = targetDateStr.split('T');
      const [year, month, day] = datePart.split('-').map(Number);
      const [hours, minutes, seconds] = timePart.split(':').map(Number);
      const dateObj = new Date(year, month - 1, day, hours, minutes, seconds);
      const melbourne = new Date(dateObj);
      const localTimezoneOffset = dateObj.getTimezoneOffset();
      const melbourneTimezoneOffset = -600;
      const offsetDiff = melbourneTimezoneOffset - localTimezoneOffset;
      melbourne.setMinutes(melbourne.getMinutes() + offsetDiff);

      return melbourne.getTime();
    }

    const targetDate = getMelbourneTime();

    function updateTimer() {
      const now = new Date().getTime();
      const distance = targetDate - now;

      if (distance <= 0) {
        daysElement.textContent = "00";
        hoursElement.textContent = "00";
        minutesElement.textContent = "00";
        secondsElement.textContent = "00";

        blocksElement.style.display = "none";
        finalMessageElement.style.display = "none";
        completeMessageElement.style.display = "block";
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      daysElement.textContent = String(days).padStart(2, '0');
      hoursElement.textContent = String(hours).padStart(2, '0');
      minutesElement.textContent = String(minutes).padStart(2, '0');
      secondsElement.textContent = String(seconds).padStart(2, '0');

      if (distance <= (finalHoursThreshold * 60 * 60 * 1000)) {
        blocksElement.style.display = "none";
        finalMessageElement.style.display = "block";
        completeMessageElement.style.display = "none";
      } else {
        blocksElement.style.display = "flex";
        finalMessageElement.style.display = "none";
        completeMessageElement.style.display = "none";
      }

      requestAnimationFrame(updateTimer);
    }

    if (targetDate) {
      updateTimer();
    }
  })();
</script>

{% schema %}
{
  "name": "Hero Countdown Timer",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Countdown Settings"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Limited Time Offer"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Do not miss out on this special offer!"
    },
    {
      "type": "text",
      "id": "target_date",
      "label": "Target Date and Time (Melbourne)",
      "default": "2025-12-31T23:59:59",
      "info": "Enter date in format: YYYY-MM-DDTHH:MM:SS (e.g., 2025-12-31T23:59:59)"
    },
    {
      "type": "header",
      "content": "Timer Labels"
    },
    {
      "type": "text",
      "id": "days_label",
      "label": "Days Label",
      "default": "Days"
    },
    {
      "type": "text",
      "id": "hours_label",
      "label": "Hours Label",
      "default": "Hours"
    },
    {
      "type": "text",
      "id": "minutes_label",
      "label": "Minutes Label",
      "default": "Minutes"
    },
    {
      "type": "text",
      "id": "seconds_label",
      "label": "Seconds Label",
      "default": "Seconds"
    },
    {
      "type": "header",
      "content": "Messages"
    },
    {
      "type": "range",
      "id": "final_hours_threshold",
      "min": 1,
      "max": 48,
      "step": 1,
      "default": 3,
      "label": "Final Hours Threshold (hours)",
      "info": "Show the final hours message when this many hours remain"
    },
    {
      "type": "text",
      "id": "final_message",
      "label": "Final Hours Message",
      "default": "Final hours! Do not miss out!"
    },
    {
      "type": "text",
      "id": "complete_message",
      "label": "Completion Message",
      "default": "The countdown has ended!"
    },
    {
      "type": "header",
      "content": "Button (Optional)"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button Link"
    }
  ],
  "presets": [
    {
      "name": "Hero Countdown Timer",
      "category": "Promotional"
    }
  ]
}
{% endschema %}
