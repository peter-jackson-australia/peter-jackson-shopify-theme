{% comment %}
  Collection Products with Grid Content Insert
{% endcomment %}

<script src="{{ 'ajaxinate.min.js' | asset_url }}" defer></script>

{% stylesheet %}
  [x-cloak] {
    display: none !important;
  }

  #collection {
    display: grid;
    grid-template-columns: auto;
  }

  .collection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-m);
  }

  .collection-controls__actions {
    display: flex;
    gap: var(--space-s);
    align-items: center;
  }

  .filter-sidebar {
    position: fixed;
    top: var(--space-xl);
    bottom: 0;
    left: 0;
    width: 400px;
    background-color: var(--white);
    z-index: 9998;
    padding: var(--space-m);
    overflow-y: auto;
    border-top: 1px solid var(--neutral-200);
  }

  .filter-sidebar__overlay {
    position: fixed;
    top: var(--space-xl);
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9997;
  }

  body.filter-open {
    overflow: hidden;
  }

  .products-grid {
    display: grid;
    gap: var(--space-xs);
  }

  .products-grid--cols-1 {
    grid-template-columns: 1fr;
  }

  .products-grid--cols-2 {
    grid-template-columns: repeat(2, 1fr);
  }

  .products-grid--cols-4 {
    grid-template-columns: repeat(4, 1fr);
  }

  .product-card {
    display: block;
    position: relative;
    height: 100%;
    overflow: hidden;
  }

  .product-card__image-link {
    display: block;
  }

  .product-card__image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    padding-bottom: 100%;
    overflow: hidden;
    background-color: var(--neutral-50);
  }

  .product-card__image {
    display: block;
    position: absolute;
    width: 100%;
  }

  .product-card__content {
    height: 120px;
    padding: var(--space-xs) 0;
    display: flex;
    flex-direction: column;
  }

  .product-card__title,
  .product-card__material {
    margin: 0 0 var(--space-xs) 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .product-card__price {
    margin-top: auto;
  }

  .product-card__slider-wrapper {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .product-card__slider {
    width: 100%;
    height: 100%;
  }

  .product-card__slider .splide__track,
  .product-card__slider .splide__list,
  .product-card__slider .splide__slide {
    height: 100%;
  }

  .product-card__slider .splide__arrows {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .product-card__slider .splide__arrow {
    z-index: 2;
    position: absolute;
    top: 50%;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    pointer-events: auto;
  }

  .product-card__slider .splide__arrow--prev {
    left: 0.5rem;
  }

  .product-card__slider .splide__arrow--next {
    right: 0.5rem;
  }

  /* Simple styles for the grid content item */
  .grid-content-item {
    background-color: #f0f0f0;
    padding: var(--space-m);
  }

  @media (max-width: 768px) {
    .filter-sidebar {
      width: 100%;
    }

    .products-grid--cols-2 {
      grid-template-columns: 1fr;
    }

    .products-grid--cols-4 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
{% endstylesheet %}

<div
  id="{{ section.id }}"
  class="section-wrap"
  x-data="
    {
      expandedGrid: true,
      isFilterOpen: false
    }
  "
  x-init="
    document.addEventListener('menu-open', () => {
      isFilterOpen = false;
      document.body.classList.remove('filter-open');
    });
  "
>
  <div id="collection" class="section">
    <div x-show="isFilterOpen" x-cloak>
      <div
        class="filter-sidebar__overlay"
        @click="isFilterOpen = false; document.body.classList.remove('filter-open')"
      ></div>
      <aside class="filter-sidebar custom-scrollbar">
        <div class="flex middle">
          <h3>Filters</h3>
          <p>
            <em><a href="{{ collection.url }}?sort_by={{ collection.sort_by }}">Clear all</a></em>
          </p>
        </div>
        {% render 'collection-filters' %}
      </aside>
    </div>

    {% paginate collection.products by section.settings.limit %}
      <div>
        <div class="section">
          <div class="collection-controls">
            <button
              class="btn"
              @click="isFilterOpen = !isFilterOpen; document.body.classList.toggle('filter-open', isFilterOpen)"
            >
              Filter
            </button>

            <p>{{ collection.products_count }} products</p>

            <div class="collection-controls__actions">
              <button class="btn" @click="expandedGrid = !expandedGrid">
                <span x-text="expandedGrid ? 'Compact View' : 'Expanded View'"></span>
              </button>
            </div>
          </div>

          {% comment %} Debug info section - will display metafield structure {% endcomment %}
          {% liquid
            assign has_grid_content = false
            if collection.metafields.custom.collection_grid_content != blank
              assign has_grid_content = true
              assign metaobject_raw = collection.metafields.custom.collection_grid_content.value
            endif
          %}

          <div style="background-color: #ffe0e0; padding: 10px; margin-bottom: 20px; border: 1px solid #ff0000;">
            <h3>Debug Information:</h3>
            <p>Metafield exists: {{ has_grid_content }}</p>
            {% if has_grid_content %}
              <p>Metaobject type: {{ collection.metafields.custom.collection_grid_content.type }}</p>
              <p>Metaobject reference:</p>
              <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto;">{{ metaobject_raw | json }}</pre>

              <p>Accessing as parsed JSON:</p>
              <ul>
                <li>Identifier: {{ metaobject_raw.identifier }}</li>
                <li>Leading Text: {{ metaobject_raw.leading_text }}</li>
                <li>Header: {{ metaobject_raw.header }}</li>
                <li>Description: {{ metaobject_raw.description }}</li>
                <li>
                  Link:
                  {% if metaobject_raw.link != blank %}{{ metaobject_raw.link | metafield_tag }}{% endif %}
                </li>
                <li>Image Or Video Reference: {{ metaobject_raw.image_or_video }}</li>
                <li>Image Or Video URL: {{ metaobject_raw.image_or_video | image_url }}</li>
                <li>Grid Position: {{ metaobject_raw.grid_position }}</li>
              </ul>
            {% endif %}
          </div>

          {% comment %} Set up variables for grid content insertion {% endcomment %}
          {% assign grid_position = 3 %}
          {% comment %} Default fallback position {% endcomment %}

          {% if has_grid_content and metaobject_raw.grid_position != blank %}
            {% assign grid_position = metaobject_raw.grid_position | plus: 0 %}
          {% endif %}

          {% assign actual_position = grid_position %}

          {% comment %} Adjust position if it exceeds the products count {% endcomment %}
          {% if grid_position > paginate.items %}
            {% assign actual_position = paginate.items %}
          {% endif %}

          {% comment %} Ensure position is at least 1 {% endcomment %}
          {% if actual_position < 1 %}
            {% assign actual_position = 1 %}
          {% endif %}

          {% comment %} Additional debug info about positions {% endcomment %}
          <div style="background-color: #e0f0ff; padding: 10px; margin-bottom: 20px; border: 1px solid #0000ff;">
            <h3>Position Information:</h3>
            <p>Products in paginate: {{ paginate.items }}</p>
            <p>Desired position: {{ grid_position }}</p>
            <p>Actual position: {{ actual_position }}</p>
            <p>Products count: {{ collection.products.size }}</p>
          </div>

          <div
            id="AjaxinateContainer"
            class="products-grid"
            :class="
              {
                'products-grid--cols-2': !expandedGrid,
                'products-grid--cols-4': expandedGrid
              }
            "
          >
            {% comment %} Loop through products and insert the content at the specified position {% endcomment %}
            {% assign inserted = false %}

            {% for product in collection.products %}
              {% assign current_position = forloop.index %}

              {% comment %} Insert grid content at the specified position {% endcomment %}
              {% if current_position == actual_position and inserted == false and has_grid_content %}
                <div class="grid-content-item" style="background-color: #cccccc; padding: 20px; text-align: center;">
                  <p style="font-size: 12px; margin-bottom: 4px;">Position: {{ current_position }}</p>

                  {% if metaobject_raw.leading_text != blank %}
                    <p>
                      <strong>{{ metaobject_raw.leading_text }}</strong>
                    </p>
                  {% endif %}

                  {% if metaobject_raw.header != blank %}
                    <h2>{{ metaobject_raw.header }}</h2>
                  {% else %}
                    <h2>TEST CONTENT INSERTED HERE</h2>
                  {% endif %}

                  {% if metaobject_raw.description != blank %}
                    <div>{{ metaobject_raw.description }}</div>
                  {% endif %}

                  {% if metaobject_raw.link != blank %}
                    <p style="margin-top: 15px;">
                      <a
                        href="{{ metaobject_raw.link.url }}"
                        class="btn"
                        style="display: inline-block; padding: 8px 16px; background-color: #333; color: white; text-decoration: none; border-radius: 4px;"
                      >
                        {{ metaobject_raw.link.text }}
                      </a>
                    </p>
                  {% endif %}
                </div>
                {% assign inserted = true %}
              {% endif %}

              {% render 'product-card', product: product, image_width: 700, image_height: 700 %}
            {% endfor %}

            {% comment %} If position is after all products, append it at the end {% endcomment %}
            {% if inserted == false and has_grid_content and paginate.current_page == 1 %}
              <div class="grid-content-item" style="background-color: #cccccc; padding: 20px; text-align: center;">
                <p style="font-size: 12px; margin-bottom: 4px;">Position: After all products</p>

                {% if metaobject_raw.leading_text != blank %}
                  <p>
                    <strong>{{ metaobject_raw.leading_text }}</strong>
                  </p>
                {% endif %}

                {% if metaobject_raw.header != blank %}
                  <h2>{{ metaobject_raw.header }}</h2>
                {% else %}
                  <h2>TEST CONTENT INSERTED AT THE END</h2>
                {% endif %}

                {% if metaobject_raw.description != blank %}
                  <div>{{ metaobject_raw.description }}</div>
                {% endif %}

                {% if metaobject_raw.link != blank %}
                  <p style="margin-top: 15px;">
                    <a
                      href="{{ metaobject_raw.link.url }}"
                      class="btn"
                      style="display: inline-block; padding: 8px 16px; background-color: #333; color: white; text-decoration: none; border-radius: 4px;"
                    >
                      {{ metaobject_raw.link.text }}
                    </a>
                  </p>
                {% endif %}
              </div>
            {% endif %}
          </div>
          <div id="AjaxinatePagination">
            {% if paginate.next %}
              <a href="{{ paginate.next.url }}">Loading More</a>
            {% endif %}
          </div>
        </div>
      </div>
    {% endpaginate %}
  </div>
</div>

{% javascript %}
  window.addEventListener('load', function () {
    var endlessScroll = new Ajaxinate({
      method: 'scroll',
      container: '#AjaxinateContainer',
      pagination: '#AjaxinatePagination',
      offset: '100',
    });

    document.addEventListener(
      'click',
      function (event) {
        if (event.target.closest('.splide__arrow')) {
          event.preventDefault();
        }
      },
      true
    );
  });
{% endjavascript %}

{% schema %}
{
  "name": "Products",
  "tag": "section",
  "class": "collection-products-section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Display current collection's products."
    },
    {
      "type": "range",
      "id": "limit",
      "label": "Products",
      "info": "Determines how many products to show before loading more.",
      "min": 4,
      "max": 50,
      "step": 1,
      "default": 8
    }
  ]
}
{% endschema %}
