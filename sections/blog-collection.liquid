{% assign selected_blog = blogs[section.settings.blog] %}
{% assign blogs_per_page = 8 %}

<h3>Filter: <span id="current-filter">none</span></h3>
<h3>Page: <span id="current-page">1</span></h3>

<ul id="article-list">
  {% for article in selected_blog.articles limit: 999 %}
    <li data-tags="{{ article.tags | join: ',' }}" style="display:none;">
      {{ article.title }} - Tags: {{ article.tags | join: ', ' }}
    </li>
  {% endfor %}
</ul>

<div id="pagination"></div>

<script>
  var urlParams = new URLSearchParams(window.location.search);
  var tagFilter = urlParams.get('tag');
  var currentPage = parseInt(urlParams.get('page')) || 1;
  var articlesPerPage = 8;

  document.getElementById('current-filter').textContent = tagFilter || 'none';
  document.getElementById('current-page').textContent = currentPage;

  var allArticles = document.querySelectorAll('#article-list li');
  var filteredArticles = [];

  allArticles.forEach(function (article) {
    if (!tagFilter) {
      filteredArticles.push(article);
    } else {
      var tags = article
        .getAttribute('data-tags')
        .split(',')
        .map(function (t) {
          return t.trim();
        });
      if (tags.includes(tagFilter)) {
        filteredArticles.push(article);
      }
    }
  });

  var totalArticles = filteredArticles.length;
  var totalPages = Math.ceil(totalArticles / articlesPerPage);
  var startIndex = (currentPage - 1) * articlesPerPage;
  var endIndex = startIndex + articlesPerPage;

  filteredArticles.forEach(function (article, index) {
    if (index >= startIndex && index < endIndex) {
      article.style.display = 'list-item';
    }
  });

  var paginationHtml = '';
  var baseUrl = window.location.pathname;

  if (totalPages > 1) {
    if (currentPage > 1) {
      var prevUrl = baseUrl + '?page=' + (currentPage - 1);
      if (tagFilter) prevUrl += '&tag=' + encodeURIComponent(tagFilter);
      paginationHtml += '<a href="' + prevUrl + '">← Previous</a> ';
    }

    for (var i = 1; i <= totalPages; i++) {
      if (i === currentPage) {
        paginationHtml += '<span style="font-weight:bold;">' + i + '</span> ';
      } else {
        var pageUrl = baseUrl + '?page=' + i;
        if (tagFilter) pageUrl += '&tag=' + encodeURIComponent(tagFilter);
        paginationHtml += '<a href="' + pageUrl + '">' + i + '</a> ';
      }
    }

    if (currentPage < totalPages) {
      var nextUrl = baseUrl + '?page=' + (currentPage + 1);
      if (tagFilter) nextUrl += '&tag=' + encodeURIComponent(tagFilter);
      paginationHtml += '<a href="' + nextUrl + '">Next →</a>';
    }

    paginationHtml +=
      '<br><br>Showing articles ' + (startIndex + 1) + '-' + Math.min(endIndex, totalArticles) + ' of ' + totalArticles;
  } else if (totalArticles === 0) {
    paginationHtml = '<p>No articles found</p>';
  } else {
    paginationHtml = '<p>Showing all ' + totalArticles + ' articles (Total: ' + totalArticles + ')</p>';
  }

  document.getElementById('pagination').innerHTML = paginationHtml;
</script>

{% schema %}
{
  "name": "Blog Collection",
  "limit": 1,
  "tag": "section",
  "class": "blog-products-section",
  "enabled_on": {
    "templates": ["page", "blog"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "info": "Optional heading for the blog section"
    },
    {
      "type": "blog",
      "id": "blog",
      "label": "Blog",
      "info": "Select which blog to display articles from"
    },
    {
      "type": "range",
      "id": "limit",
      "label": "Limit",
      "info": "Limit the number of articles displayed per page.",
      "min": 4,
      "max": 50,
      "step": 1,
      "default": 8
    },
    {
      "type": "range",
      "id": "articles_per_row",
      "label": "Articles Per Row",
      "info": "Number of articles per row.",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 3
    }
  ],
  "presets": [
    {
      "name": "Blog Collection",
      "category": "Blog"
    }
  ]
}
{% endschema %}
