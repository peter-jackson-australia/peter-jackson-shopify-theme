{% comment %}
  Blog collection section
  Refactored by Jed 7th August 2025
{% endcomment %}

{{ 'section-blog-collection.css' | asset_url | stylesheet_tag }}

{% assign selected_blog = blogs[section.settings.blog] %}
{% assign blogs_per_page = section.settings.limit %}
{% assign heading = section.settings.heading %}

{% assign tag_filter = request.url | split: '?tag=' | last | url_decode %}
{% if tag_filter == request.url %}
  {% assign tag_filter = null %}
{% endif %}

{% assign is_empowered_mind = false %}
{% if request.path contains '/pages/the-empowered-mind' %}
  {% assign is_empowered_mind = true %}
{% endif %}

{% assign article_count = 0 %}
{% for article in selected_blog.articles %}
  {% assign show_article = false %}

  {% if is_empowered_mind %}
    {% if article.tags contains 'Lifestyle' %}
      {% if tag_filter %}
        {% if article.tags contains tag_filter %}
          {% assign show_article = true %}
        {% endif %}
      {% else %}
        {% assign show_article = true %}
      {% endif %}
    {% endif %}
  {% elsif tag_filter %}
    {% if article.tags contains tag_filter %}
      {% assign show_article = true %}
    {% endif %}
  {% else %}
    {% assign show_article = true %}
  {% endif %}

  {% if show_article %}
    {% assign article_count = article_count | plus: 1 %}
  {% endif %}
{% endfor %}

{% paginate selected_blog.articles by blogs_per_page %}
  <div class="blog-collection">
    {% if heading %}
      <h2 class="blog-collection__heading heading--xl">{{ heading }}</h2>
    {% endif %}

    {% assign has_articles = false %}

    <div class="blog-collection__grid">
      {% for article in selected_blog.articles %}
        {% assign show_article = false %}

        {% if is_empowered_mind %}
          {% if article.tags contains 'Lifestyle' %}
            {% if tag_filter %}
              {% if article.tags contains tag_filter %}
                {% assign show_article = true %}
              {% endif %}
            {% else %}
              {% assign show_article = true %}
            {% endif %}
          {% endif %}
        {% elsif tag_filter %}
          {% if article.tags contains tag_filter %}
            {% assign show_article = true %}
          {% endif %}
        {% else %}
          {% assign show_article = true %}
        {% endif %}

        {% if show_article %}
          {% assign has_articles = true %}
          {% assign current_img = article.image %}
          {% assign current_url = article.url %}
          {% assign current_title = article.title %}
          {% assign current_tags_count = article.tags.size %}
          {% assign current_tags_first = article.tags.first %}

          <article class="blog-collection__post">
            {% if current_img %}
              <a href="{{ current_url }}" class="blog-collection__post-image">
                {{
                  current_img
                  | image_url: width: 850
                  | image_tag:
                    loading: 'lazy',
                    decoding: 'async',
                    alt: current_title,
                    widths: '400, 600, 800, 1000, 1200, 1400, 1600, 1800, 2000, 2400, 3000',
                    sizes: '(max-width: 400px) 400px, (max-width: 600px) 600px, (max-width: 800px) 800px, (max-width: 1000px) 1000px, (max-width: 1200px) 1200px, (max-width: 1400px) 1400px, (max-width: 1600px) 1600px, (max-width: 1800px) 1800px, (max-width: 2000px) 2000px, (max-width: 2400px) 2400px, 100vw'
                }}
              </a>
            {% endif %}

            <div class="blog-collection__post-content">
              {% if current_tags_count > 0 %}
                <div class="blog-collection__post-category small">{{ current_tags_first }}</div>
              {% endif %}

              <h3 class="blog-collection__post-title heading--l">
                <a href="{{ current_url }}">{{ current_title }}</a>
              </h3>

              <a href="{{ current_url }}" class="blog-collection__post-link-container">
                <span class="blog-collection__post-link body"
                  >Read The Article {% render '_icon-arrow-submit-dark' -%}
                </span>
              </a>
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>

    {% unless has_articles %}
      <div class="blog-collection__empty">
        <h3>No Articles Found</h3>
      </div>
    {% endunless %}

    {% if paginate.pages > 1 and has_articles %}
      <div class="blog-collection__pagination">
        <script>
          document.addEventListener('DOMContentLoaded', function () {
            var paginationLinks = document.querySelectorAll('.blog-collection__pagination a');
            var tagParam = new URLSearchParams(window.location.search).get('tag');
            paginationLinks.forEach(function (link) {
              if (tagParam && !link.href.includes('tag=')) {
                var separator = link.href.includes('?') ? '&' : '?';
                link.href = link.href + separator + 'tag=' + encodeURIComponent(tagParam);
              }
            });
          });
        </script>

        {% render 'pagination', paginate: paginate %}
      </div>
    {% endif %}
  </div>
{% endpaginate %}

{% schema %}
{
  "name": "Blog Collection",
  "limit": 1,
  "tag": "section",
  "class": "blog-products-section",
  "enabled_on": {
    "templates": ["page", "blog"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "info": "Optional heading for the blog section"
    },
    {
      "type": "blog",
      "id": "blog",
      "label": "Blog",
      "info": "Select which blog to display articles from"
    },
    {
      "type": "range",
      "id": "limit",
      "label": "Limit",
      "info": "Limit the number of articles displayed per page.",
      "min": 4,
      "max": 50,
      "step": 1,
      "default": 8
    },
    {
      "type": "range",
      "id": "articles_per_row",
      "label": "Articles Per Row",
      "info": "Number of articles per row.",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 3
    }
  ],
  "presets": [
    {
      "name": "Blog Collection",
      "category": "Blog"
    }
  ]
}
{% endschema %}
