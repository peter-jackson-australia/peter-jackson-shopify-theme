{% comment %}
  Main product gallery and information
{% endcomment %}
{% assign current_variant = product.selected_or_first_available_variant %}

{% if product.featured_image %}
  {{
    product.featured_image
    | image_url: width: 1024
    | image_tag:
      widths: '600, 800, 1024, 1440',
      sizes: '(max-width: 768px) 100vw, 50vw',
      preload: true,
      style: 'display: none;'
  }}
{% endif %}

<style>
  .product-images-container {
    position: relative;
    width: 50vw;
    height: calc(100dvh - var(--space-xl));
    overflow: hidden;
  }

  .product-images-container--mobile {
    width: 100%;
    height: auto;
    aspect-ratio: auto;
  }

  .product-images-container--mobile .splide__slide {
    position: relative;
    padding-bottom: 100%;
  }

  .product-images-container--mobile .splide__slide img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-images-splide .splide__track {
    height: 100%;
  }

  .product-images-splide .splide__list {
    height: 100% !important;
  }

  .product-images-splide .splide__slide {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background-color: var(--neutral-50);
    position: relative;
  }

  .product-images-splide .splide__slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    object-position: top;
  }

  .product-images-splide .splide__slide:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--neutral-50);
    z-index: -1;
  }

  .product-images-progress {
    position: absolute;
    left: var(--space-m);
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 50%;
    background-color: var(--neutral-50);
    z-index: 10;
  }

  .product-images-progress--mobile {
    left: 50%;
    top: auto;
    bottom: var(--space-m);
    transform: translateX(-50%);
    width: 30%;
    height: 2px;
  }

  .product-images-progress__bar {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 0;
    background-color: var(--neutral-950);
    transition: height 0.3s ease;
  }

  .product-images-progress--mobile .product-images-progress__bar {
    width: 0;
    height: 100%;
    transition: width 0.3s ease;
  }

  .product-images-splide .splide__arrows {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    margin: 0;
    pointer-events: none;
  }

  .product-images-splide .splide__arrow {
    background-color: transparent;
    border: none;
    width: var(--space-l);
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    opacity: 1;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: auto;
    padding: 0;
  }

  .product-images-splide .splide__arrow--prev {
    left: var(--space-3xs);
  }

  .product-images-splide .splide__arrow--next {
    right: var(--space-3xs);
  }

  .product-images-splide .splide__arrow:disabled {
    opacity: 0.3;
    cursor: default;
  }

  .product-images-splide .splide__arrow svg {
    width: 7px;
    height: 12px;
  }

  .product-images-progress {
    position: absolute;
    left: var(--space-m);
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 30%;
    background-color: var(--neutral-200);
    z-index: 10;
  }

  .product-images-progress__bar {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 0;
    background-color: var(--neutral-950);
    transition: height 0.3s ease;
  }

  .product-images-progress--mobile {
    left: 0;
    top: auto;
    bottom: 0;
    transform: none;
    width: 100%;
    height: 2px;
    background: transparent;
    z-index: 2;
  }

  .product-images-progress--mobile .product-images-progress__bar {
    width: 0;
    height: 2px;
    transition: width 300ms ease;
  }

  #product {
    display: flex;
    gap: var(--space-2xl);
  }

  #product-details {
    flex: 1;
    padding: var(--space-xl) var(--space-l);
  }

  @media screen and (max-width: 768px) {
    #product {
      flex-direction: column;
      gap: var(--space-l);
    }

    #product-details {
      padding: var(--space-m);
    }

    .product-images-splide .splide__arrows {
      display: none;
    }

    .product-images-container--mobile .splide__arrows {
      display: block;
    }
  }
</style>

<script>
  var current_variant = {{ current_variant | json }};
  var variants = {{ product.variants | json }};
  var default_image = {{ product.featured_image.id | default: 'null' }};
</script>

<div class="section-wrap">
  <div id="product">
    <div class="product-images-container">
      <div class="splide product-images-splide">
        <div class="splide__arrows">
          <button class="splide__arrow splide__arrow--prev">
            <svg width="7" height="12" viewBox="0 0 7 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 1L1 6L6 11" stroke="#0F0F0F" stroke-linecap="square"/>
            </svg>
          </button>
          <button class="splide__arrow splide__arrow--next">
            <svg width="7" height="12" viewBox="0 0 7 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 1L6 6L1 11" stroke="#0F0F0F" stroke-linecap="square"/>
            </svg>
          </button>
        </div>

        <div class="splide__track">
          <ul class="splide__list">
            {% if product.images.size == 0 %}
              <li class="splide__slide">
                {{ 'collection-4' | placeholder_svg_tag: 'placeholder' }}
              </li>
            {% endif %}
            {% for image in product.images %}
              {% assign image_width = 1024 %}
              {% assign image_height = image_width | divided_by: image.aspect_ratio | ceil %}
              <li class="splide__slide" data-imageid="{{ image.id }}">
                <img
                  src="{{ image.src | image_url: width: image_width }}"
                  srcset="
                    {{ image.src | image_url: width: 600 }} 600w,
                    {{ image.src | image_url: width: 800 }} 800w,
                    {{ image.src | image_url: width: 1024 }} 1024w,
                    {{ image.src | image_url: width: 1440 }} 1440w
                  "
                  sizes="(max-width: 768px) 100vw, 50vw"
                  width="{{ image_width }}"
                  height="{{ image_height }}"
                  alt="{{ image.alt }}"
                  loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                  {% if forloop.first %}
                    fetchpriority="high"
                  {% endif %}
                  decoding="{% if forloop.first %}sync{% else %}async{% endif %}"
                >
              </li>
            {% endfor %}
          </ul>
        </div>

        <div class="product-images-progress">
          <div class="product-images-progress__bar"></div>
        </div>
      </div>
    </div>

    <section id="product-details">
      <h1 data-title="{{ product.title }}">{{ product.title }}</h1>

      <p>
        Product Code:
        <span class="js--variant-sku">{{ current_variant.sku }}</span>
      </p>

      <p class="rte">
        {{ product.description }}
      </p>

      {% comment %}
        Variant selector.
      {% endcomment %}
      <div>
        <form action="{{ routes.cart_add_url }}" method="post">
          {%- for block in section.blocks -%}
            {% case block.type %}
              {%- when '@app' -%}
                {% render block %}

              {%- when 'prices' -%}
                <p>
                  <strike class="js--variant-compareatprice">
                    {%- if current_variant.compare_at_price > current_variant.price -%}
                      {{- current_variant.compare_at_price | money -}}
                    {%- endif -%}
                  </strike>
                  <strong class="js--variant-price">
                    {{ current_variant.price | money }}
                  </strong>
                </p>

              {%- when 'options' %}
                {% unless product.has_only_default_variant %}
                  {% for option_group in product.options_with_values %}
                    {% assign option_field = option_group.position | prepend: 'option' %}
                    <div>
                      <fieldset class="variant-options js--variant-options">
                        <legend>{{ option_group.name | prepend: 'Select ' }}</legend>
                        {% for value in option_group.values %}
                          {% capture option_id %}{{ option_group.name }}_{{ value }}{% endcapture %}
                          <div class="variant-option">
                            <input
                              type="radio"
                              id="{{ option_id | handleize }}"
                              class="js--variant-option"
                              name="{{ option_group.position | prepend: 'option'}}"
                              value="{{ value }}"
                              {% if current_variant[option_field] == value %}
                                checked
                              {% endif %}
                            >
                            <label for="{{ option_id | handleize }}">
                              {{- value -}}
                            </label>
                          </div>
                        {% endfor %}
                      </fieldset>
                    </div>
                  {% endfor %}
                {% endunless %}

              {%- when 'button' -%}
                <div>
                  <input
                    type="hidden"
                    id="js--variant-id"
                    name="id"
                    value="{{ current_variant.id }}"
                  >
                  {% if current_variant.available == true %}
                    <button type="submit" id="js--addtocart">
                      {{ block.settings.button_label }}
                    </button>
                  {% else %}
                    <button type="submit" id="js--addtocart" disabled>Unavailable</button>
                  {% endif %}
                </div>
            {%- endcase -%}
          {%- endfor -%}
        </form>
      </div>
    </section>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const checkSplide = setInterval(function () {
      if (typeof Splide !== 'undefined') {
        clearInterval(checkSplide);
        initializeProductSlider();
      }
    }, 100);

    function initializeProductSlider() {
      let splideInstance = null;
      const container = document.querySelector('.product-images-container');
      const progressBar = document.querySelector('.product-images-progress__bar');

      function initSlider() {
        if (splideInstance) {
          splideInstance.destroy();
        }

        const isMobile = window.innerWidth < 768;

        const options = isMobile
          ? {
              type: 'slide',
              arrows: true,
              perPage: 1,
              pagination: false,
              rewind: false,
              drag: true,
              speed: 300,
              waitForTransition: true,
            }
          : {
              direction: 'ttb',
              height: '100vh',
              wheel: true,
              waitForTransition: true,
              arrows: false,
              pagination: false,
              speed: 300,
              drag: true,
            };

        splideInstance = new Splide('.product-images-splide', options);

        splideInstance.on('mounted move', function () {
          const end = splideInstance.Components.Controller.getEnd() + 1;
          const rate = Math.min((splideInstance.index + 1) / end, 1);

          if (isMobile) {
            progressBar.style.width = String(100 * rate) + '%';
          } else {
            progressBar.style.height = String(100 * rate) + '%';
          }
        });

        splideInstance.mount();

        if (isMobile) {
          container.classList.add('product-images-container--mobile');
        } else {
          container.classList.remove('product-images-container--mobile');
        }

        const progress = document.querySelector('.product-images-progress');
        if (isMobile) {
          progress.classList.add('product-images-progress--mobile');
        } else {
          progress.classList.remove('product-images-progress--mobile');
        }
      }

      initSlider();

      let resizeTimeout;
      window.addEventListener('resize', function () {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(initSlider, 250);
      });
    }
  });
</script>

{% schema %}
{
  "name": "Product Page",
  "settings": [],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "options",
      "name": "Product options",
      "limit": 1,
      "settings": []
    },
    {
      "type": "prices",
      "name": "Prices",
      "settings": []
    },
    {
      "type": "button",
      "name": "Add to cart",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "button_label",
          "label": "Button Label",
          "default": "Add to cart"
        }
      ]
    }
  ]
}
{% endschema %}
