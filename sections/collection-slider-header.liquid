{% comment %}
  Collection Slider Header Section
{% endcomment %}

<style>
  .collection-slider-header {
    width: 100%;
  }

  .collection-slider-header__header {
    display: flex;
    padding: var(--space-2xl) var(--space-m);
    gap: var(--space-xl);
  }

  .collection-slider-header__header-left {
    display: flex;
    align-items: center;
    flex: 1;
  }

  .collection-slider-header__title {
    padding-right: var(--space-m);
    color: var(--neutral-950);
    white-space: nowrap;
  }

  .collection-slider-header__divider {
    height: 50px;
    width: 1px;
    background-color: var(--neutral-200);
  }

  .collection-slider-header__subtitle {
    padding-left: var(--space-m);
    color: var(--neutral-950);
    margin-top: -7px;
  }

  .collection-slider-header__nav {
    flex: 1;
    display: flex;
    align-items: center;
    overflow: auto;
  }

  .collection-slider-header__nav-list {
    display: flex;
    justify-content: end;
    gap: var(--space-m);
    list-style: none;
    margin-left: auto;
    max-height: 100%;
  }

  .collection-slider-header__nav-button {
    white-space: nowrap;
    text-decoration: none;
    color: var(--neutral-950);
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    font: inherit;
  }

  .collection-slider-header__nav-button.active {
    text-decoration: underline;
  }

  .collection-slider-header__images-container {
    width: 100%;
    position: relative;
    overflow: hidden;
    padding: 0 var(--space-m);
  }

  .collection-slider-header__image-wrapper {
    position: relative;
    width: 100%;
    display: none;
  }

  .collection-slider-header__image-wrapper.active {
    display: block;
  }

  .collection-slider-header__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top;
  }

  .collection-slider-header__slider-section {
    padding: var(--space-2xl) var(--space-m);
    overflow: hidden;
    border-bottom: 1px solid var(--neutral-50);
    display: none;
  }

  .collection-slider-header__slider-section.active {
    display: block;
  }

  .collection-slider-header__slider-container {
    display: flex;
    gap: var(--space-l);
    width: 100%;
    overflow: visible;
  }

  .collection-slider-header__slider-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex: 1;
    min-width: 30vw;
  }

  .collection-slider-header__slider-heading {
    margin-bottom: var(--space-2xs);
    color: var(--neutral-950);
  }

  .collection-slider-header__slider-description {
    max-width: 80ch;
    margin-bottom: var(--space-l);
    color: var(--neutral-600);
  }

  .collection-slider-header__slider-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    text-decoration: none;
    color: var(--neutral-950);
  }

  .collection-slider-header__slider-wrapper {
    overflow: visible;
    width: 100%;
    flex: 2;
  }

  .collection-slider-header__slider {
    width: calc(100% + var(--space-m));
    margin-right: 0;
  }

  .collection-slider-header__product-link {
    display: block;
    text-decoration: none;
    color: var(--neutral-950);
  }

  .collection-slider-header__product-image-wrapper {
    margin-bottom: var(--space-xs);
    overflow: hidden;
    background-color: var(--neutral-50);
  }

  .collection-slider-header__product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .collection-slider-header__product-title {
    margin: var(--space-xs) 0 var(--space-2xs);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--neutral-950);
  }

  .collection-slider-header__product-material {
    margin-bottom: var(--space-2xs);
    color: var(--neutral-600);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .collection-slider-header__product-price {
    margin-bottom: var(--space-2xs);
  }

  .collection-slider-header__product-price--compare {
    text-decoration: line-through;
    color: var(--neutral-600);
    margin-left: var(--space-2xs);
  }

  @media screen and (max-width: 1440px) {
    .collection-slider-header__header {
      padding-top: var(--space-xl);
      padding-bottom: var(--space-xl);
      flex-direction: column;
      align-items: center;
      gap: var(--space-m);
    }

    .collection-slider-header__header-left {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-m);
    }

    .collection-slider-header__title {
      padding-right: 0;
    }

    .collection-slider-header__divider {
      display: none;
    }

    .collection-slider-header__subtitle {
      padding-left: 0px;
    }

    .collection-slider-header__nav {
      align-items: start;
    }

    .collection-slider-header__nav-list {
      flex-wrap: wrap;
      justify-content: center;
      padding-bottom: var(--space-s);
      margin-left: 0px;
    }
  }

  @media screen and (max-width: 768px) {
    .collection-slider-header__slider-section {
      padding-top: var(--space-xl);
      padding-bottom: var(--space-xl);
    }

    .collection-slider-header__image-wrapper {
      height: 100%;
    }

    .collection-slider-header__slider-container {
      flex-direction: column;
      width: 100%;
      gap: 0px;
    }

    .collection-slider-header__slider-content {
      margin-bottom: var(--space-xl);
    }

    .collection-slider-header__product-title {
      width: calc(100% - var(--space-m));
    }

    .collection-slider-header__slider {
      width: calc(100% + var(--space-l));
    }

    .collection-slider-header__nav {
      overflow-x: auto;
    }
  }

  @media screen and (max-width: 570px) {
    .collection-slider-header__images-container {
      height: 60vh;
      order: -1;
    }
  }

  @media screen and (max-width: 470px) {
    .collection-slider-header__slider-wrapper {
      overflow: hidden;
    }
  }
</style>

<div class="collection-slider-header" id="section-{{ section.id }}">
  <div class="collection-slider-header__header">
    <div class="collection-slider-header__header-left">
      {% if section.settings.main_heading != blank %}
        <h2 class="collection-slider-header__title heading--decorative">
          {{ section.settings.main_heading }}
        </h2>
      {% endif %}

      <span class="collection-slider-header__divider"></span>

      {% if section.settings.subtitle != blank %}
        <h3 class="collection-slider-header__subtitle heading--l">
          {{ section.settings.subtitle }}
        </h3>
      {% endif %}
    </div>

    <nav class="collection-slider-header__nav custom-scrollbar">
      <ul class="collection-slider-header__nav-list">
        {% for block in section.blocks %}
          <li class="collection-slider-header__nav-item">
            <button
              class="collection-slider-header__nav-button body--uppercase {% if forloop.first %}active{% endif %}"
              data-index="{{ forloop.index0 }}"
            >
              {{ block.settings.nav_label }}
            </button>
          </li>
        {% endfor %}
      </ul>
    </nav>
  </div>

  <div class="collection-slider-header__images-container">
    {% for block in section.blocks %}
      <div
        class="collection-slider-header__image-wrapper {% if forloop.first %}active{% endif %}"
        data-image-index="{{ forloop.index0 }}"
      >
        <picture>
          {% if block.settings.mobile_image != blank %}
            <source
              media="(max-width: 767px)"
              srcset="
                {{ block.settings.mobile_image | image_url: width: 400 }} 1x,
                {{ block.settings.mobile_image | image_url: width: 800 }} 2x
              "
            >
          {% endif %}

          {% if forloop.first %}
            {{
              block.settings.desktop_image
              | image_url: width: 1920
              | image_tag:
                loading: 'eager',
                decoding: 'async',
                alt: block.settings.nav_label,
                class: 'collection-slider-header__image',
                widths: '400, 600, 800, 1000, 1200, 1400, 1600, 1800, 2000, 2400, 3000',
                sizes: '(max-width: 400px) 400px, (max-width: 600px) 600px, (max-width: 800px) 800px, (max-width: 1000px) 1000px, (max-width: 1200px) 1200px, (max-width: 1400px) 1400px, (max-width: 1600px) 1600px, (max-width: 1800px) 1800px, (max-width: 2000px) 2000px, (max-width: 2400px) 2400px, 100vw'
            }}
          {% else %}
            {{
              block.settings.desktop_image
              | image_url: width: 1920
              | image_tag:
                loading: 'lazy',
                decoding: 'async',
                alt: block.settings.nav_label,
                class: 'collection-slider-header__image',
                widths: '400, 600, 800, 1000, 1200, 1400, 1600, 1800, 2000, 2400, 3000',
                sizes: '(max-width: 400px) 400px, (max-width: 600px) 600px, (max-width: 800px) 800px, (max-width: 1000px) 1000px, (max-width: 1200px) 1200px, (max-width: 1400px) 1400px, (max-width: 1600px) 1600px, (max-width: 1800px) 1800px, (max-width: 2000px) 2000px, (max-width: 2400px) 2400px, 100vw'
            }}
          {% endif %}
        </picture>
      </div>
    {% endfor %}
  </div>

  {% for block in section.blocks %}
    <div
      class="collection-slider-header__slider-section {% if forloop.first %}active{% endif %}"
      data-index="{{ forloop.index0 }}"
    >
      <div class="collection-slider-header__slider-container">
        <div class="collection-slider-header__slider-content">
          {% if block.settings.slider_heading != blank %}
            <h2 class="heading--2xl collection-slider-header__slider-heading">
              {{ block.settings.slider_heading }}
            </h2>
          {% endif %}

          {% if block.settings.slider_description != blank %}
            <p class="body collection-slider-header__slider-description">
              {{ block.settings.slider_description }}
            </p>
          {% endif %}

          {% if block.settings.collection != blank and block.settings.button_label != blank %}
            <a href="{{ block.settings.collection.url }}" class="body collection-slider-header__slider-link">
              {{ block.settings.button_label }}
              {% render '_icon-arrow-submit-dark' %}
            </a>
          {% endif %}
        </div>

        {% if block.settings.collection != blank %}
          <div class="collection-slider-header__slider-wrapper">
            <div class="collection-slider-header__slider splide" id="slider-{{ section.id }}-{{ forloop.index0 }}">
              <div class="splide__arrows">
                <button class="splide__arrow splide__arrow--prev">{% render '_icon-arrow-see-less' %}</button>
                <button class="splide__arrow splide__arrow--next">{% render '_icon-arrow-see-more' %}</button>
              </div>
              <div class="splide__track">
                <div class="splide__list">
                  {% assign product_limit = block.settings.products_to_show | default: 10 %}
                  {% for product in block.settings.collection.products limit: product_limit %}
                    <article class="splide__slide collection-slider-header__slide">
                      <a href="{{ product.url }}" class="collection-slider-header__product-link">
                        <div class="collection-slider-header__product-image-wrapper">
                          {% if product.featured_image != blank %}
                            <img
                              src="{{ product.featured_image | image_url: width: '600' }}"
                              alt="{{ product.featured_image.alt | escape }}"
                              loading="lazy"
                              width="{{ product.featured_image.width }}"
                              height="{{ product.featured_image.height }}"
                              class="collection-slider-header__product-image"
                              decoding="async"
                            >
                          {% else %}
                            {{
                              'product-1'
                              | placeholder_svg_tag: 'collection-slider-header__product-image placeholder'
                            }}
                          {% endif %}
                        </div>

                        <h3 class="body--bold collection-slider-header__product-title">{{ product.title }}</h3>

                        {% if product.metafields.custom.fabric_description != blank %}
                          <p class="small collection-slider-header__product-material">
                            {{ product.metafields.custom.fabric_description }}
                          </p>
                        {% endif %}

                        <p class="small collection-slider-header__product-price">
                          {% if product.compare_at_price > product.price %}
                            <span class="collection-slider-header__product-price--sale">
                              {{- product.price | money -}}
                            </span>
                            <span class="collection-slider-header__product-price--compare">
                              {{- product.compare_at_price | money -}}
                            </span>
                          {% else %}
                            {{ product.price | money }}
                          {% endif %}
                        </p>
                      </a>

                      {% if product.metafields.custom.product_colour_variants %}
                        {% assign colour_variants = product.metafields.custom.product_colour_variants.value %}
                        {% assign max_display = 3 %}
                        {% assign remaining_count = colour_variants.count | minus: max_display %}

                        <div class="product-card__swatches">
                          {% assign current_colour = product.metafields.custom.swatch_colour.value.colour | strip %}
                          {% assign current_name = product.metafields.custom.swatch_colour.value.name | strip %}
                          {% assign bg_colour = current_colour | default: 'var(--neutral-200)' %}

                          <a
                            href="{{ product.url }}"
                            class="product-card__swatch-link"
                            aria-label="View {{ product.title }} variant"
                            style="border: 1px solid var(--neutral-950); padding: 1px;"
                          >
                            <div
                              class="product-card__swatch{% if current_name == 'White' %} product-card__swatch--white{% endif %}"
                              style="background-color: {{ bg_colour }};"
                              aria-hidden="true"
                            ></div>
                          </a>

                          {% for variant in colour_variants limit: max_display %}
                            {% assign variant_colour = variant.metafields.custom.swatch_colour.value.colour | strip %}
                            {% assign variant_name = variant.metafields.custom.swatch_colour.value.name | strip %}
                            {% assign border_colour = variant_colour | default: 'var(--neutral-950)' %}
                            {% assign bg_colour = variant_colour | default: 'var(--neutral-200)' %}

                            <a
                              href="{{ variant.url }}"
                              class="product-card__swatch-link"
                              aria-label="View {{ variant.title }} variant"
                              style="border: 2px solid {{ border_colour }};"
                            >
                              <div
                                class="product-card__swatch{% if variant_name == 'White' %} product-card__swatch--white{% endif %}"
                                style="background-color: {{ bg_colour }};"
                                aria-hidden="true"
                              ></div>
                            </a>
                          {% endfor %}

                          {% if remaining_count > 0 %}
                            <p class="small">+{{ remaining_count }}</p>
                          {% endif %}
                        </div>
                      {% endif %}
                    </article>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const collectionSliderHeader = document.getElementById('section-{{ section.id }}');
    if (!collectionSliderHeader) return;

    const navigationButtons = collectionSliderHeader.querySelectorAll('.collection-slider-header__nav-button');
    const heroImages = collectionSliderHeader.querySelectorAll('.collection-slider-header__image-wrapper');
    const collectionSliderSections = collectionSliderHeader.querySelectorAll(
      '.collection-slider-header__slider-section'
    );

    const splideConfig = {
      perPage: 4,
      type: 'loop',
      gap: 'var(--space-2xs)',
      arrows: false,
      pagination: false,
      drag: true,
      snap: true,
      breakpoints: {
        470: { perPage: 1 },
        768: { perPage: 2, arrows: true },
      },
    };

    function initializeSplideCarousel(sliderSection) {
      const carouselElement = sliderSection.querySelector('.splide');
      if (carouselElement && !carouselElement.classList.contains('is-initialized')) {
        new Splide(carouselElement, splideConfig).mount();
      }
    }

    function switchToNavigationItem(selectedIndex) {
      navigationButtons.forEach(function (navButton) {
        navButton.classList.toggle('active', navButton.dataset.index === selectedIndex);
      });

      heroImages.forEach(function (heroImage) {
        heroImage.classList.toggle('active', heroImage.dataset.imageIndex === selectedIndex);
      });

      collectionSliderSections.forEach(function (sliderSection) {
        const isActive = sliderSection.dataset.index === selectedIndex;
        sliderSection.classList.toggle('active', isActive);
        if (isActive) initializeSplideCarousel(sliderSection);
      });
    }

    initializeSplideCarousel(collectionSliderSections[0]);

    navigationButtons.forEach(function (navButton) {
      navButton.addEventListener('click', function () {
        switchToNavigationItem(navButton.dataset.index);
      });
    });
  });
</script>

{% schema %}
{
  "name": "Collection Slider Header",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "main_heading",
      "label": "Main Heading",
      "default": "New Collections"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Seasonal Favorites"
    }
  ],
  "blocks": [
    {
      "type": "navigation_item",
      "name": "Navigation Item",
      "limit": 5,
      "settings": [
        {
          "type": "text",
          "id": "nav_label",
          "label": "Navigation Label",
          "default": "Collection Name"
        },
        {
          "type": "image_picker",
          "id": "desktop_image",
          "label": "Desktop Image"
        },
        {
          "type": "image_picker",
          "id": "mobile_image",
          "label": "Mobile Image (optional)"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "text",
          "id": "slider_heading",
          "label": "Slider Heading",
          "default": "New In Now"
        },
        {
          "type": "textarea",
          "id": "slider_description",
          "label": "Slider Description",
          "default": "Layer up with premium wool/cashmere blends."
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button Label",
          "default": "Shop Now"
        },
        {
          "type": "range",
          "id": "products_to_show",
          "min": 3,
          "max": 12,
          "step": 1,
          "default": 10,
          "label": "Maximum products to show"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collection Slider Header",
      "category": "Collection",
      "blocks": [
        {
          "type": "navigation_item",
          "settings": {
            "nav_label": "New Arrivals",
            "slider_heading": "New Arrivals"
          }
        },
        {
          "type": "navigation_item",
          "settings": {
            "nav_label": "Suits",
            "slider_heading": "Suits Collection"
          }
        }
      ]
    }
  ],
  "enabled_on": {
    "templates": ["index", "page", "article", "blog"]
  }
}
{% endschema %}
